<!-- navbarLoggedIn.html: Navbar for logged-in users extracted from browseLoggedIn.html -->
<div class="navbar-wrapper">
    <div class="navbar">
    <p class="title">üèñÔ∏è Arriba Ivisan</p>
    <div class="nav-links">
        <div style="display:flex; align-items:center;">
            <button id="back-btn" style="margin-right:12px; background:#fff; border:1px solid #4a90e2; color:#4a90e2; font-size:1rem; font-weight:bold; cursor:pointer; border-radius:6px; padding:6px 18px; box-shadow:0 2px 8px rgba(74,144,226,0.08); transition:background 0.2s;">Back</button>
            <div class="search-container">
                <input class="search" type="text" placeholder="Search...">
                <svg class="search-icon" viewBox="0 0 24 24">
                    <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" fill="none"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65" stroke="currentColor" stroke-width="2"/>
                </svg>
            </div>
        </div>
        <a class="bell" title="Pending" id="pending-icon" style="position:relative">
            <svg fill="#000000" viewBox="0 0 1920 1920" width="30px" xmlns="http://www.w3.org/2000/svg">
                <path d="M1190.725 1368.395c77.93 63.247 151.68 122.993 191.096 252.763l22.25 72.96H515.336l22.137-72.96c39.416-129.77 113.167-189.516 191.21-252.763l169.524-137.675c35.577-28.913 87.304-29.026 122.993.113l169.525 137.562Zm142.306-641.393c135.529-109.891 304.263-246.663 304.263-670.531V0H282v56.47c0 423.869 168.734 560.64 304.264 670.532 88.884 72.057 147.5 119.605 147.5 232.998 0 113.393-58.616 160.941-147.5 232.885C450.734 1302.889 282 1439.66 282 1863.529V1920h1355.294v-56.47c0-423.869-168.734-560.64-304.263-670.645-88.772-71.944-147.502-119.492-147.502-232.885 0-113.393 58.73-160.941 147.502-232.998Z" fill-rule="evenodd"></path>
            </svg>
            <span id="pending-badge" style="display:none; position:absolute; top:-6px; right:-6px; background:#FFA500; color:#fff; font-size:12px; padding:2px 6px; border-radius:12px;">0</span>
        </a>
        <a class="bell" title="Notifications" id="bell-icon">
            <svg viewBox="0 0 24 24" fill="none" width="40px" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M12.0009 5C13.4331 5 14.8066 5.50571 15.8193 6.40589C16.832 7.30606 17.4009 8.52696 17.4009 9.8C17.4009 11.7691 17.846 13.2436 18.4232 14.3279C19.1606 15.7133 19.5293 16.406 19.5088 16.5642C19.4849 16.7489 19.4544 16.7997 19.3026 16.9075C19.1725 17 18.5254 17 17.2311 17H6.77066C5.47638 17 4.82925 17 4.69916 16.9075C4.54741 16.7997 4.51692 16.7489 4.493 16.5642C4.47249 16.406 4.8412 15.7133 5.57863 14.3279C6.1558 13.2436 6.60089 11.7691 6.60089 9.8C6.60089 8.52696 7.16982 7.30606 8.18251 6.40589C9.19521 5.50571 10.5687 5 12.0009 5ZM12.0009 5V3M9.35489 20C10.0611 20.6233 10.9888 21.0016 12.0049 21.0016C13.0209 21.0016 13.9486 20.6233 14.6549 20" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>
        </a>
        <a class="chat" title="Chat" id="chat-icon" style="position:relative">
            <svg viewBox="0 0 24 24" fill="none" width="35px" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M17 3.33782C15.5291 2.48697 13.8214 2 12 2C6.47715 2 2 6.47715 2 12C2 13.5997 2.37562 15.1116 3.04346 16.4525C3.22094 16.8088 3.28001 17.2161 3.17712 17.6006L2.58151 19.8267C2.32295 20.793 3.20701 21.677 4.17335 21.4185L6.39939 20.8229C6.78393 20.72 7.19121 20.7791 7.54753 20.9565C8.88837 21.6244 10.4003 22 12 22C17.5228 22 22 17.5228 22 12C22 10.1786 21.513 8.47087 20.6622 7" stroke="#1C274C" stroke-width="1.5" stroke-linecap="round"></path> <path d="M8 12H8.009M11.991 12H12M15.991 12H16" stroke="#1C274C" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>
            <span id="chat-badge" style="display:none; position:absolute; top:-6px; right:-6px; background:#ff4d4f; color:#fff; font-size:12px; padding:2px 6px; border-radius:12px;">0</span>
        </a>
        <a href="{{ url_for('owner_profile') }}" class="profile" title="Profile">
            <svg viewBox="0 0 24 24" fill="none" width="35px" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M14.5 8.5C14.5 9.88071 13.3807 11 12 11C10.6193 11 9.5 9.88071 9.5 8.5C9.5 7.11929 10.6193 6 12 6C13.3807 6 14.5 7.11929 14.5 8.5Z" fill="#000000"></path> <path d="M15.5812 16H8.50626C8.09309 16 7.87415 15.5411 8.15916 15.242C9.00598 14.3533 10.5593 13 12.1667 13C13.7899 13 15.2046 14.3801 15.947 15.2681C16.2011 15.5721 15.9774 16 15.5812 16Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path> <circle cx="12" cy="12" r="10" stroke="#000000" stroke-width="2"></circle> </g></svg>
        </a>
    </div>
    </div>
    <!-- Small banner below navbar -->
    <div class="navbar-banner" role="note" aria-label="site description">
        Ivisan Resorts and Beach Online Browsing and Reservation System
    </div>
</div>

<style>
    /* navbar sizing variables: total height includes banner */
    :root {
        --navbar-total-height: 10vh;
        --navbar-banner-height: 2.4vh; /* slightly larger banner for readability */
        --navbar-gap: 0.4vh; /* small visual gap between navbar and banner (kept inside total) */
    }
    /* wrapper enforces exact total header height so it can't push page height */
    .navbar-wrapper {
        height: var(--navbar-total-height, 10vh);
        overflow: hidden; /* prevent header children from increasing document height */
        display: flex;
        flex-direction: column;
        width: 100%;
        gap: var(--navbar-gap, 0.4vh);
    }

    .navbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        /* subtract the banner height and the visual gap so total stays exact */
        flex: 0 0 calc(var(--navbar-total-height, 10vh) - var(--navbar-banner-height, 2.4vh) - var(--navbar-gap, 0.4vh));
        box-sizing: border-box;
        padding: 0 60px; /* reduce horizontal padding so content fits */
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        min-height: 0; /* allow shrinking to computed flex-basis */
    }
    .title {
        font-size: 20px; /* slightly smaller to fit */
        font-weight: 700;
        color: #333;
        margin: 0; /* remove any default spacing */
    }
    .nav-links {
        display: flex;
        align-items: center;
        justify-content: center ;
    }
    .nav-links a {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 20px;
        text-decoration: none;
        color: #333;
        font-weight: bold;
    }
    .search-container {
        position: relative;
        width: 220px; /* narrower search so navbar content fits comfortably */
    }
    .search {
        width: 100%;
        padding: 10px 40px 10px 10px; /* right padding for icon */
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 16px;
    }
    .search-icon {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        pointer-events: none;
        fill: #888;
    }
    /* Small bottom banner under navbar */
    .navbar-banner {
        width: 100%;
        background: linear-gradient(90deg, #2193b0 0%, #6dd5ed 100%);
        color: #fff;
        text-align: center;
        /* fixed flex-basis to keep total header height exact */
        flex: 0 0 var(--navbar-banner-height, 2.4vh);
        height: var(--navbar-banner-height, 2.4vh);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 12px;
        font-size: 0.95rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.06);
        letter-spacing: 0.2px;
        min-height: 0; /* allow banner to shrink to the specified var height */
        line-height: 1;
        border-radius: 0 0 6px 6px; /* subtle rounded corners for visual separation */
    }
    @media (max-width: 600px) {
        .navbar { padding: 0 16px; }
        .navbar-banner { font-size: 0.8rem; height: calc(var(--navbar-banner-height,2vh) + 4px); padding: 0 8px; }
        .search-container { width: 160px; }
    }
</style>

<!-- Modal HTML for notification, message, chat, and pending boxes -->
<div id="notification-box" style="display:none; position:absolute; top:70px; right:120px; width:350px; background:#fff; box-shadow:0 4px 24px rgba(0,0,0,0.12); border-radius:12px; z-index:1000; font-family:Georgia, 'Times New Roman', Times, serif;">
    <div style="padding:18px 20px 10px 20px; border-bottom:1px solid #eee; font-weight:bold; font-size:1.1rem; letter-spacing:1px; text-align:center;">
        NOTIFICATIONS
    </div>
    <div id="notification-list" style="padding:16px 20px; max-height:400px; overflow:auto;">
        <!-- populated dynamically -->
    </div>
</div>
<div id="message-box" style="display:none; position:absolute; top:70px; right:70px; width:350px; background:#fff; box-shadow:0 4px 24px rgba(0,0,0,0.12); border-radius:12px; z-index:1000; font-family:Georgia, 'Times New Roman', Times, serif;">
    <div style="padding:18px 20px 10px 20px; border-bottom:1px solid #eee; font-weight:bold; font-size:1.1rem; letter-spacing:1px; text-align:center;">
        MESSAGES
    </div>
    <div id="message-list" style="padding:16px 20px; max-height:320px; overflow:auto;">
        <!-- populated dynamically -->
    </div>
</div>
<div id="chat-ui" style="display:none; position:absolute; top:70px; right:70px; width:350px; background:#fff; box-shadow:0 4px 24px rgba(0,0,0,0.12); border-radius:12px; z-index:1001; font-family:Georgia, 'Times New Roman', Times, serif;">
    <div id="chat-header" style="padding:18px 20px 10px 20px; border-bottom:1px solid #eee; font-weight:bold; font-size:1.1rem; letter-spacing:1px; text-align:center;">
        Resort Name
    </div>
    <div id="chat-messages" style="padding:16px 20px; min-height:120px;">
        <!-- Messages will appear here -->
    </div>
    <div style="padding:10px 20px; border-top:1px solid #eee; display:flex; gap:8px;">
        <input id="chat-input" type="text" placeholder="Type a message..." style="flex:1; padding:8px; border-radius:6px; border:1px solid #ccc;">
        <button id="send-btn" style="padding:8px 12px; border:none; background:#4a90e2; color:#fff; border-radius:6px;">Send</button>
    </div>
</div>
<div id="pending-box" style="display:none; position:absolute; top:70px; right:170px; width:350px; background:#fff; box-shadow:0 4px 24px rgba(0,0,0,0.12); border-radius:12px; z-index:1000; font-family:Georgia, 'Times New Roman', Times, serif;">
    <div style="padding:18px 20px 10px 20px; border-bottom:1px solid #eee; font-weight:bold; font-size:1.1rem; letter-spacing:1px; text-align:center;">
        PENDING
    </div>
    <div id="pending-list" style="padding:16px 20px; max-height:320px; overflow:auto;">
        <!-- populated dynamically -->
    </div>
</div>

<script>
    const bell = document.getElementById('bell-icon');
    const box = document.getElementById('notification-box');
    const chatIcon = document.getElementById('chat-icon');
    const messageBox = document.getElementById('message-box');
    const chatUI = document.getElementById('chat-ui');
    const chatHeader = document.getElementById('chat-header');
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const pendingIcon = document.getElementById('pending-icon');
    const pendingBox = document.getElementById('pending-box');

    // Back button logic
    const backBtn = document.getElementById('back-btn');
    if (backBtn) {
        // Only show if not on browse.html
        if (window.location.pathname.endsWith('/browse') || window.location.pathname.endsWith('/browse.html')) {
            backBtn.style.display = 'none';
        } else {
            backBtn.style.display = 'inline-block';
            backBtn.addEventListener('click', function() {
                window.location.href = '/browse';
            });
        }
    }

    // Helper to close all popups
    function closeAllPopups() {
        box.style.display = 'none';
        messageBox.style.display = 'none';
        chatUI.style.display = 'none';
        pendingBox.style.display = 'none';
    }

    bell.addEventListener('click', function(e) {
        e.stopPropagation();
        closeAllPopups();
        loadNotifications();
        box.style.display = 'block';
    });

    chatIcon.addEventListener('click', function(e) {
        e.stopPropagation();
        closeAllPopups();
        messageBox.style.display = 'block';
    });

    pendingIcon.addEventListener('click', function(e) {
        e.stopPropagation();
        closeAllPopups();
        loadPendingReservations();
        pendingBox.style.display = 'block';
    });

    document.addEventListener('click', function(e) {
        closeAllPopups();
    });

    box.addEventListener('click', function(e) {
        e.stopPropagation();
    });

    messageBox.addEventListener('click', function(e) {
        e.stopPropagation();
        if (e.target.classList.contains('message-item')) {
            const resort = e.target.getAttribute('data-resort');
            chatHeader.textContent = resort;
            let conversation = '';
            if (resort === 'White Sand Hills Beach Resort') {
                conversation = `
                    <div style="margin-bottom:8px;"><b>Owner:</b> Hi! Your booking is confirmed.</div>
                    <div style="text-align:right; margin-bottom:8px; color:#4a90e2;"><b>You:</b> Thank you! What time is check-in?</div>
                    <div style="margin-bottom:8px;"><b>Owner:</b> Check-in starts at 2PM. See you!</div>
                `;
            } else if (resort === 'RBM Virgin Beach and Resort') {
                conversation = `
                    <div style="margin-bottom:8px;"><b>Owner:</b> Your food order will arrive soon.</div>
                    <div style="text-align:right; margin-bottom:8px; color:#4a90e2;"><b>You:</b> Great, thank you!</div>
                `;
            }
            chatMessages.innerHTML = conversation;
            closeAllPopups();
            chatUI.style.display = 'block';
        }
    });

    // Dynamic messages and badge: fetch recent conversations from server
    async function loadRecentConversations() {
        try {
            const res = await fetch('/api/recent_conversations');
            const data = await res.json();
            if (!data || !data.success) return;
            const list = document.getElementById('message-list');
            list.innerHTML = '';
            let unreadCount = 0;
            data.conversations.forEach(conv => {
                const item = document.createElement('div');
                item.className = 'message-item';
                item.style.cursor = 'pointer';
                item.setAttribute('data-conversation-id', conv.id);
                item.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:700">${escapeHtml(conv.partner_name || 'Conversation')}</div><div style="font-size:0.85rem;color:#666">${conv.last_time ? new Date(conv.last_time).toLocaleString() : ''}</div></div><div style="color:#4a90e2;margin-top:6px;">${escapeHtml(conv.last_text || '')}</div>`;
                if (conv.unread) {
                    const dot = document.createElement('span');
                    dot.style.background = '#ff4d4f';
                    dot.style.width = '10px';
                    dot.style.height = '10px';
                    dot.style.display = 'inline-block';
                    dot.style.borderRadius = '50%';
                    dot.style.marginLeft = '8px';
                    item.querySelector('div').appendChild(dot);
                    unreadCount += 1;
                }
                item.addEventListener('click', function() {
                    // navigate to owner chats and open conversation
                    window.location.href = '/owner/chats?conversation_id=' + conv.id;
                });
                const sep = document.createElement('div');
                sep.style.height = '1px';
                sep.style.background = '#eee';
                sep.style.margin = '10px 0';
                list.appendChild(item);
                list.appendChild(sep);
            });
            const badge = document.getElementById('chat-badge');
            if (unreadCount > 0) {
                badge.style.display = 'inline-block';
                badge.textContent = unreadCount;
            } else {
                badge.style.display = 'none';
            }
        } catch (e) {
            console.error('loadRecentConversations', e);
        }
    }

    // simple HTML escaper
    function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

    // Load pending reservations
    async function loadPendingReservations() {
        try {
            const res = await fetch('/api/pending_reservations');
            const data = await res.json();
            if (!data || !data.success) return;
            
            const list = document.getElementById('pending-list');
            list.innerHTML = '';
            
            if (data.reservations.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#666; padding:20px;">No pending reservations</div>';
                return;
            }
            
            data.reservations.forEach(reservation => {
                const item = document.createElement('div');
                item.innerHTML = `
                    <div style="font-weight:bold; margin-bottom:4px;">${escapeHtml(reservation.customer_name)}: ${escapeHtml(reservation.resource_type)}</div>
                    <div style="color:#FFA500; margin-bottom:8px;">Booking is awaiting your approval</div>
                    <div style="margin-bottom:8px; font-size:0.9rem; color:#666;">
                        ${escapeHtml(reservation.resource_name)} ‚Ä¢ ${reservation.guests} guest(s)<br>
                        ${formatDate(reservation.check_in)} - ${formatDate(reservation.check_out)}
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
                        <span>${escapeHtml(reservation.resource_name)}</span>
                        <div style="display:flex; gap:4px;">
                            <button class="approve-reservation-btn" data-reservation-id="${reservation.id}" style="background:#52c41a; color:#fff; border:none; border-radius:6px; padding:4px 8px; font-size:0.8rem; cursor:pointer;">Approve</button>
                            <button class="decline-reservation-btn" data-reservation-id="${reservation.id}" style="background:#ff4d4f; color:#fff; border:none; border-radius:6px; padding:4px 8px; font-size:0.8rem; cursor:pointer;">Decline</button>
                        </div>
                    </div>
                `;
                
                const sep = document.createElement('div');
                sep.style.height = '1px';
                sep.style.background = '#eee';
                sep.style.margin = '10px 0';
                
                list.appendChild(item);
                if (data.reservations.indexOf(reservation) < data.reservations.length - 1) {
                    list.appendChild(sep);
                }
            });
            
            // Add event listeners to approve/decline buttons
            document.querySelectorAll('.approve-reservation-btn').forEach(btn => {
                btn.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    const reservationId = this.getAttribute('data-reservation-id');
                    if (confirm('Are you sure you want to approve this reservation?')) {
                        try {
                            const response = await fetch(`/api/owner/reservations/${reservationId}/action`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ action: 'confirm' })
                            });
                            const result = await response.json();
                            if (result.success) {
                                loadPendingReservations(); // Reload the list
                                updatePendingBadge(); // Update badge count
                            } else {
                                alert('Failed to approve reservation: ' + (result.message || 'Unknown error'));
                            }
                        } catch (error) {
                            alert('Network error while approving reservation');
                        }
                    }
                });
            });
            
            document.querySelectorAll('.decline-reservation-btn').forEach(btn => {
                btn.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    const reservationId = this.getAttribute('data-reservation-id');
                    if (confirm('Are you sure you want to decline this reservation?')) {
                        try {
                            const response = await fetch(`/api/owner/reservations/${reservationId}/action`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ action: 'cancel' })
                            });
                            const result = await response.json();
                            if (result.success) {
                                loadPendingReservations(); // Reload the list
                                updatePendingBadge(); // Update badge count
                            } else {
                                alert('Failed to decline reservation: ' + (result.message || 'Unknown error'));
                            }
                        } catch (error) {
                            alert('Network error while declining reservation');
                        }
                    }
                });
            });
        } catch (e) {
            console.error('loadPendingReservations', e);
        }
    }
    
    // Update pending badge count
    async function updatePendingBadge() {
        try {
            const res = await fetch('/api/pending_reservations');
            const data = await res.json();
            if (data && data.success) {
                const badge = document.getElementById('pending-badge');
                if (data.reservations.length > 0) {
                    badge.style.display = 'inline-block';
                    badge.textContent = data.reservations.length;
                } else {
                    badge.style.display = 'none';
                }
            }
        } catch (e) {
            console.error('updatePendingBadge', e);
        }
    }
    
    // Format date helper
    function formatDate(dateStr) {
        if (!dateStr) return '';
        try {
            return new Date(dateStr).toLocaleDateString();
        } catch (e) {
            return dateStr;
        }
    }

    // Load initially and when opening message box
    loadRecentConversations();
    chatIcon.addEventListener('click', function(){ loadRecentConversations(); });
    
    // Load notifications function
    async function loadNotifications() {
        try {
            const res = await fetch('/api/owner/notifications');
            const data = await res.json();
            if (!data || !data.success) return;
            
            const list = document.getElementById('notification-list');
            list.innerHTML = '';
            
            if (data.notifications.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#666; padding:20px;">No notifications</div>';
                return;
            }
            
            data.notifications.forEach(notification => {
                const item = document.createElement('div');
                item.className = 'notification-item';
                item.style.cursor = 'pointer';
                item.style.padding = '12px 0';
                item.style.opacity = notification.is_read ? '0.6' : '1';
                
                const icon = notification.type === 'offer_approved' ? '‚úÖ' : 'üîî';
                const date = new Date(notification.created_at).toLocaleDateString();
                
                item.innerHTML = `
                    <div style="display:flex; align-items:start; gap:10px;">
                        <div style="font-size:1.5rem;">${icon}</div>
                        <div style="flex:1;">
                            <div style="font-weight:bold; margin-bottom:4px;">${escapeHtml(notification.title)}</div>
                            <div style="color:#666; margin-bottom:4px; font-size:0.9rem;">${escapeHtml(notification.message)}</div>
                            <div style="color:#999; font-size:0.8rem;">${date}</div>
                        </div>
                    </div>
                `;
                
                item.addEventListener('click', async function() {
                    if (!notification.is_read) {
                        await fetch('/api/notifications/' + notification.id + '/mark-read', { method: 'POST' });
                        item.style.opacity = '0.6';
                        updateNotificationBadge();
                    }
                });
                
                const sep = document.createElement('div');
                sep.style.height = '1px';
                sep.style.background = '#eee';
                sep.style.margin = '10px 0';
                
                list.appendChild(item);
                if (data.notifications.indexOf(notification) < data.notifications.length - 1) {
                    list.appendChild(sep);
                }
            });
        } catch (e) {
            console.error('loadNotifications', e);
        }
    }
    
    // Update notification badge count
    async function updateNotificationBadge() {
        try {
            const res = await fetch('/api/notifications/unread-count');
            const data = await res.json();
            if (data && data.success) {
                const badge = document.getElementById('bell-icon');
                // Note: We'll add a badge element if notifications exist
                // For now, just log the count
                console.log('Unread notifications:', data.count);
            }
        } catch (e) {
            console.error('updateNotificationBadge', e);
        }
    }

    // Load pending reservations initially and update badge
    updatePendingBadge();
    setInterval(updatePendingBadge, 30000); // Update every 30 seconds
    
    // Update notification badge
    updateNotificationBadge();
    setInterval(updateNotificationBadge, 30000); // Update every 30 seconds

    chatUI.addEventListener('click', function(e) {
        e.stopPropagation();
    });

    sendBtn.addEventListener('click', function() {
        const msg = chatInput.value.trim();
        if (msg) {
            chatMessages.innerHTML += `<div style="text-align:right; margin-bottom:8px; color:#4a90e2;">${msg}</div>`;
            chatInput.value = '';
        }
    });

    pendingBox.addEventListener('click', function(e) {
        e.stopPropagation();
    });

    // Close popups when clicking any nav link except the one being clicked
    document.querySelectorAll('.nav-links a').forEach(link => {
        link.addEventListener('click', function(e) {
            // Only close if not the current icon
            if (
                e.currentTarget !== bell &&
                e.currentTarget !== chatIcon &&
                e.currentTarget !== pendingIcon
            ) {
                closeAllPopups();
            }
        });
    });
</script>
